# H `RankedBattle.sol` no minimum stake and rounding issue. Causing User whom stake lots of token earn same amount of points as user whom stake 1 wei token

10 user stake 1e1 (1wei) token earn the same amount total points as single user stake 100e18 $NRN.
100 user stake 1e1 (1wei) token earn the same amount total points as single user stake 10_000e18 $NRN.

Rewards distribution per round spread evenly for all player based on points. This leads to unfair rewards distribution.

Also because of rounding issue, user who deposit less than 1_000 token never get their stake removed when lost battle.
Basically encourage user to stake 1 wei token for entire round.

They will get same amount of points on ranking same as user who put actual money on staking.

## Impact

Rewards distribute evenly per round for all player based on points.
Points can be earned by staking 1 wei token have same weight as staking 2e18 token.

Basically free points and rewards for doing absolutely nothing and not putting any serious money at risk.

## Proof of Concept

Rewards distribution per round is based on points ranking. [The more point you have, the more rewards you get.](https://docs.aiarena.io/gaming-competition/nrn-rewards)

Only user who have token staked allowed to earn points after battle

```js
//https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L341-L344
        uint256 stakeAtRisk = _stakeAtRiskInstance.getStakeAtRisk(tokenId);//@stake always 0 after 1st stake
        if (amountStaked[tokenId] + stakeAtRisk > 0) {
            _addResultPoints(battleResult, tokenId, eloFactor, mergingPortion, fighterOwner);
        }//@audit user with no stake cannot add resultPoints. There is never points increase.
```

Look at stake function. There is no minimum stake required.
<https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L241-L265>

And how points earned is calculated based on `StakingFactor` and elo.

```js
//https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L416-L500
        /// Check how many NRNs the fighter has at risk
        stakeAtRisk = _stakeAtRiskInstance.getStakeAtRisk(tokenId);
        /// Calculate the staking factor if it has not already been calculated for this round 
        if (_calculatedStakingFactor[tokenId][roundId] == false) {
            stakingFactor[tokenId] = _getStakingFactor(tokenId, stakeAtRisk);//@minimum 1 as staking factor
            _calculatedStakingFactor[tokenId][roundId] = true;//@ staking factor decimal is 0. if deposit 100e18. staking factor is 100^0.5=10
        }

        // .......

        /// If the user has no NRNs at risk, then they can earn points
        if (stakeAtRisk == 0) {
            points = stakingFactor[tokenId] * eloFactor;
        }

```

There is problem with [`StakingFactor` calculation.](https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L519-L534)

Deposit 100e18 token give you `square root of 100=10` staking factor.
Deposit 2e18 token give you `square root of 2=1` staking factor.
Deposit 1e1 token give you 0 staking factor and rounded up to 1.

It always rounding up to 1 when deposit staking token is less than 2e18.

```js
    function _getStakingFactor(
        uint256 tokenId, 
        uint256 stakeAtRisk
    ) 
        private 
        view 
        returns (uint256) 
    {
      uint256 stakingFactor_ = FixedPointMathLib.sqrt(
          (amountStaked[tokenId] + stakeAtRisk) / 10**18//@audit R getstaking factor seem manipulated by staking <1e18
      );
      if (stakingFactor_ == 0) {
        stakingFactor_ = 1;//@ staking always round up to 1
      }
      return stakingFactor_;
    }
```

This mean user deposit 1e1 token have same staking factor as user deposit 1e18 token.
They allowed to [earn points](https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L465-L468) and [rewards based on points earned](https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L294-L312).

Also due to another [rounding issue.](https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L438-L439)

```js
    /// Potential amount of NRNs to put at risk or retrieve from the stake-at-risk contract
    curStakeAtRisk = (bpsLostPerLoss * (amountStaked[tokenId] + stakeAtRisk)) / 10**4;//@div  10000 //@audit H no minimum staking amount result in never get stake at risk
```

User who deposit less than 1_000 token never get their stake at risk due to `curStakeAtRisk == 0`.
This in turn prevent contract from remove their stake when they lose battle.
<https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L491-L498>

### Combined all previous issues

This incentived cheating user to deposit 1 wei every round to earn points and some token rewards.
It cost nothing and still earn rewards. As automatic battle and game server will keep sending battle report to update for all users.

## Tools Used
<https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L519-L534>

## Recommended Mitigation Steps

Add minimum stake required to earn points and rewards.

```solidity
    uint256 public minimumDeposit = 10e18;
    function setMinimumDeposit(uint256 _minimumDeposit) external onlyOwner {
        minimumDeposit = _minimumDeposit;
    }

    function stakeNRN(uint256 amount, uint256 tokenId) external {//@audit can stake for ongoing round. This mean when battle going for halfway. User can still stake for winner?
        require(amount > minimumDeposit, "Amount cannot less than minimumDeposit");
```
