# Forgot update `RankedBattle.globalStakedAmount` when admin sweep token after new round

Assume this is invariant rule is true:

- `globalStakedAmount = sum(amountStaked[tokenId]) + sum(stakeAtRisk[tokenId])` for all tokenId

This rule is broken when admin start new round sweep all `stakeAtRisk` token to treasury.

`globalStakedAmount` never updated and still keep track of lost staked token.

If all user decided to withdraw/unstake all their stake after new round start.
`globalStakedAmount` will not be zero. Which it fail [the comment show what it should be](https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L58).

## Impact

`globalStakedAmount` fail to show all staked token from all users.

## Proof of Concept

Based on code `globalStakedAmount` should keep tracked [total stake for current round only.](https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L58-L59)

```solidity
/// @notice Number of overall staked amount.
uint256 public globalStakedAmount = 0;
```

`globalStakedAmount` is updated when user[stake and unstake](https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L244-L290)
`globalStakedAmount` increase and decrease along side with `amountStaked[tokenId]`

```solidity
    amountStaked[tokenId] += amount;
    globalStakedAmount += amount;
    //....
    amountStaked[tokenId] -= amount;
    globalStakedAmount -= amount;
```

`amountStaked[tokenId]` can be decrease later when there is token at risk when they lose.
<https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L496>
Or increase back to original value of that round if they win enough round.
<https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L460-L463>

So `globalStakedAmount` keep track right amount.

The problem is current stake at risk is only available for that round only.

```solidity
//https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L430-L440
        stakeAtRisk = _stakeAtRiskInstance.getStakeAtRisk(tokenId);
        ...
        /// Potential amount of NRNs to put at risk or retrieve from the stake-at-risk contract
        curStakeAtRisk = (bpsLostPerLoss * (amountStaked[tokenId] + stakeAtRisk)) / 10**4;//@div  10000 //@audit-ok H no minimum staking amount result in never get stake at risk
```

```solidity
//https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/StakeAtRisk.sol#L132-L134
    function getStakeAtRisk(uint256 fighterId) external view returns(uint256) {
        return stakeAtRisk[roundId][fighterId];
    }
```

And when admin sweep all token at risk to start new round.
<https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L233-L239>
<https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/StakeAtRisk.sol#L78-L84>
<https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/StakeAtRisk.sol#L142-L144>

All `amountStaked[tokenId]` decrease by `stakeAtRisk` now permanent zero without any way to increase back.
`globalStakedAmount` now not equal to sum of `amountStaked[tokenId]` anymore.

## Tools Used

<https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L233-L239>

## Recommended Mitigation Steps

Decrease global stake amount when admin sweep token at risk to treasury.

```solidity
    function setNewRound() external {
        require(isAdmin[msg.sender]);
        require(totalAccumulatedPoints[roundId] > 0);
+++        globalStakedAmount -= _stakeAtRiskInstance.totalStakeAtRisk(roundId);
        roundId += 1;
        _stakeAtRiskInstance.setNewRound(roundId);//@audit M global staked does not update when stake at risk is removed
        rankedNrnDistribution[roundId] = rankedNrnDistribution[roundId - 1];
    }
```
