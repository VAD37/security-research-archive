# NFT fighter can have no stake after losing battle. But NFT still locked and cannot transfer NFT to another account

`FighterFarm.sol` NFT suppose to be transferable to another account if have no staked token.
But is not due to missing logic check in `RankedBattle._addResultPoints()`.

## Impact

NFT token no longer have staked token. But still cannot transfer to another account.
It require user to call `unstake()` zero token is make it transferable

## Proof of Concept

NFT cannot be transferred to another account if it is staked.

```js
    function _ableToTransfer(uint256 tokenId, address to) private view returns(bool) {
        return (
          _isApprovedOrOwner(msg.sender, tokenId) &&
          balanceOf(to) < MAX_FIGHTERS_ALLOWED &&
          !fighterStaked[tokenId]
        );
    }
```

Stake NFT can only happen in `RankedBattle.sol`
<https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L244-L290>

Look at this logic. When token no longer have any stake, remove staking status

```js
        if (amountStaked[tokenId] == 0) {
            _fighterFarmInstance.updateFighterStaking(tokenId, false);
        }
```

`RankedBattle.updateBattleRecord()` can remove all `amountStaked[tokenId]` when fighter lost battle.
These stake token are moved to stake at risk.
[But does not update staking status when it no longer have any stake.](https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L493-L497)

```js

    bool success = _neuronInstance.transfer(_stakeAtRiskAddress, curStakeAtRisk);
    if (success) {
        _stakeAtRiskInstance.updateAtRiskRecords(curStakeAtRisk, tokenId, fighterOwner);
        amountStaked[tokenId] -= curStakeAtRisk;
        //@curStakeAtRisk is clamped max to amountStaked[tokenId]
        //@fund is moved to stake at risk
    }
```

[When round is over, admin can sweep all stake at risk to treasury.](https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L239)
Then token will no longer have any stake but staking status still persist.
This prevent NFT from transfer away unless call `unstake()` first.

## Tools Used

<https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/RankedBattle.sol#L493-L497>
<https://github.com/code-423n4/2024-02-ai-arena/blob/f2952187a8afc44ee6adc28769657717b498b7d4/src/FighterFarm.sol#L539-L545>

## Recommended Mitigation Steps

Always update staking status.

```git
        /// If the user has stake-at-risk for their fighter, reclaim a portion
        /// Reclaiming stake-at-risk puts the NRN back into their staking pool
        if (curStakeAtRisk > 0) {
+            if(amountStaked[tokenId] == 0) {
+                _fighterFarmInstance.updateFighterStaking(tokenId, true);
+            }
            _stakeAtRiskInstance.reclaimNRN(curStakeAtRisk, tokenId, fighterOwner);
            amountStaked[tokenId] += curStakeAtRisk;
        }
```

```git

    bool success = _neuronInstance.transfer(_stakeAtRiskAddress, curStakeAtRisk);
    if (success) {
        _stakeAtRiskInstance.updateAtRiskRecords(curStakeAtRisk, tokenId, fighterOwner);
        amountStaked[tokenId] -= curStakeAtRisk;
+        if (amountStaked[tokenId] == 0) {
+            _fighterFarmInstance.updateFighterStaking(tokenId, false);
+        }
    }
```
