
# Token Price fluctuation between pool sDAI, wstETH, weETH lead to unfair point allocation

## Summary

`SophonFarming.sol` have 3 main pool during initialization. With 5 another similar token pool will be [added later](https://github.com/sherlock-audit/2024-05-sophon-VAD37/blob/948a548b545fc35e5b9fc817384822e48b88c0f4/farming-contracts/scripts/deploy.py#L1-L18).
Which are: wstETH,weETH,ezETH,rsETH,rswETH,uniETH,pufETH and sDAI.

DAI token is odd one out as it price 3000x higher than other token and its price is not fixed and fluctuate along ETH price.
To compensate for this and making sure all pools points is spread evenly as much as possible, admin must set DAI point allocation to 3_000_000, while other pool would be 1_000.

This is not ideal and current admin configuration does not compensate for this.

Allocation point is fixed and admin can updated it later.But because DAI token price change everytime, this lead to unfair point allocation between pool.

## Vulnerability Detail

Here is price of pool token converted:
1 ETH ~= 3800 sDAI
1 ETH = 1 stETH = 0.856 wstETH
1 ETH = 1 eETH = 1.03897 weETH

[Here is code of point allocation calculation:](https://github.com/sherlock-audit/2024-05-sophon-VAD37/blob/948a548b545fc35e5b9fc817384822e48b88c0f4/farming-contracts/contracts/farm/SophonFarming.sol#L412-L436)

```solidity
    function updatePool(uint256 _pid) public {
        PoolInfo storage pool = poolInfo[_pid];
        if (getBlockNumber() <= pool.lastRewardBlock) {
            return;
        }
        uint256 lpSupply = pool.amount;//deposit + boostAmount
        uint256 _pointsPerBlock = pointsPerBlock;//25e18
        uint256 _allocPoint = pool.allocPoint;//20000 could also be > 1e18
        if (lpSupply == 0 || _pointsPerBlock == 0 || _allocPoint == 0) {
            pool.lastRewardBlock = getBlockNumber();
            return;
        }
        uint256 blockMultiplier = _getBlockMultiplier(pool.lastRewardBlock, getBlockNumber());//block passed * 1e18
        uint256 pointReward =
            blockMultiplier *//300e18
            _pointsPerBlock *// * 25e18
            _allocPoint /    // * 20000
            totalAllocPoint; // 80000
        //@spread points evenly between pools
        pool.accPointsPerShare = pointReward /
            lpSupply +
            pool.accPointsPerShare;
        //accPointsPerShare+= 1-1000e18 *25e18 * 20000/80000 / 0-100000e18
        pool.lastRewardBlock = getBlockNumber();
    }
```

To simplify:
`accPointsPerShare += blockPassed * pointsPerBlock * poolAllocPoint / totalAllocPoint / totalTokenPoints`

Each pool have its own allocation point divided by total points of all pool.
So it is normal for some pool worth more than other pool. Depend on admin config.

It is required by admin to set DAI pool have allocation point 3000x than other pool due to its price. 4000 sDAI worth as much as 1 wstETH.

Current Admin config for allocation points between sDAI and wstETH pool is 20000:20000.
<https://github.com/sherlock-audit/2024-05-sophon-VAD37/blob/948a548b545fc35e5b9fc817384822e48b88c0f4/farming-contracts/scripts/deploy.py#L256-L257>

Because points accumulated divided by how much token deposited. DAI obviously deposited a lot more than wstETH.
Despite have same points allocation, sDAI receive way much less points than wstETH.

Because ETH price is not fixed, the conversion of price between token pool is not fixed.
This lead to unfair point allocation between pool.

## Impact

If ETH price drop too much, user deposit in DAI pool will receive more points than other ETH pool because its rewards allocation point is higher than other pool.

## Code Snippet

## Tool used

Manual Review

## Recommendation
