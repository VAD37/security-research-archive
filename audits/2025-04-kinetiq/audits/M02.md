# `ValidatorManager.closeRebalanceRequests()` does not work as intended. It reverts due to an unnecessary validation check

## Summary

`StakingManager.processValidatorRedelegation()` has this weird check [here](https://github.com/code-423n4/2025-04-kinetiq/blob/7f29c917c09341672e73be2f7917edf920ea2adb/src/StakingManager.sol#L365):

`require(address(this).balance >= amount, "Insufficient balance");`

However, `StakingManager.sol` is not supposed to hold HYPE balance on L2 most of the time. This validation simply causes a revert.

## Impact

When the Admin tries to cancel a rebalance order, there will not be enough HYPE tokens in the buffer (hype buffer is zero), causing a revert.
Additionally, this check is unnecessary since the Validator Manager operations only handle L1 staking delegation. There is no need to check for L2 balance.

## Finding description

The description explains why the above balance check is unnecessary and can be safely removed.

`ValidatorManager.sol` allows the Manager role to call these two functions:

- `rebalanceWithdrawal()`: Creates a withdrawal pending order on `StakingManager.sol`. The order execution will attempt to undelegate staking from the validator on L1.
- `closeRebalanceRequests()`: Creates a deposit pending order on `StakingManager.sol`. The order execution will delegate from the `StakingManager` address to the validator address on L1.

1. If we examine what executing a pending order does, it goes through `processL1Operations()`, `_processL1Deposits()` [(ref)](https://github.com/code-423n4/2025-04-kinetiq/blob/7f29c917c09341672e73be2f7917edf920ea2adb/src/StakingManager.sol#L741), and `_processL1Withdrawals()` [(ref)](https://github.com/code-423n4/2025-04-kinetiq/blob/7f29c917c09341672e73be2f7917edf920ea2adb/src/StakingManager.sol#L692-L693). All these functions ultimately call `l1Write.sendTokenDelegate()`, which essentially delegates or undelegates from the validator account. (move token between spot to staking is ignored, only user operation trigger this L1 stake/unstake operation)

This is explained in the L1 HyperCore documentation: [L1 op](https://hyperliquid.gitbook.io/hyperliquid-docs/for-developers/api/exchange-endpoint#delegate-or-undelegate-stake-from-validator), [staking delegation](https://hyperliquid.gitbook.io/hyperliquid-docs/hypercore/staking).

2. The validation `require(address(this).balance >= amount, "Insufficient balance");` is unnecessary.  
The function `closeRebalanceRequests()` encounters an issue with the validation check when it [reaches here](https://github.com/code-423n4/2025-04-kinetiq/blob/7f29c917c09341672e73be2f7917edf920ea2adb/src/ValidatorManager.sol#L280-L283):
`IStakingManager(stakingManager).processValidatorRedelegation(totalAmount);`

```solidity
    function processValidatorRedelegation(uint256 amount) external nonReentrant whenNotPaused { //@cancel previous rebalance delegation by Manager
        require(msg.sender == address(validatorManager), "Only ValidatorManager");
        require(amount > 0, "Invalid amount");
        require(address(this).balance >= amount, "Insufficient balance"); //@audit M why redelegation takes CASH from the HYPE buffer balance. This is supposed to be just undelegation.

        _distributeStake(amount, OperationType.RebalanceDeposit);
    }
```

`address(this).balance` is only exist thanks to the HYPE buffer, which take cash from user withdrawals, deposits then keep it on L2 balances.
Since the Validator Manager only handles current L1 staking operations, there is no need to check the L2 balance. There is simply no new withdraw/deposit staking token during validator manager rebalance operation.

## Recommended mitigation steps

Remove the balance check. The manager should check for the L1 staking balance instead. The check should resemble the following logic. However, it is unclear how to read L1 staking data, so take the fix as an inspiration:

```solidity
    function processValidatorRedelegation(uint256 amount) external nonReentrant whenNotPaused { //@cancel previous rebalance delegation by Manager
        require(msg.sender == address(validatorManager), "Only ValidatorManager");
        require(amount > 0, "Invalid amount");
        // require(address(this).balance >= amount, "Insufficient balance"); //@audit M why redelegation takes CASH from the HYPE buffer balance. This is supposed to be just undelegation.
        require(l1Read.delegatorSummary(address(this)).undelegated > amount, "L1 does not have enough leftover staking to delegate");
        _distributeStake(amount, OperationType.RebalanceDeposit);
    }
```
