# Exploit reducing KEROSENE price and force liquidation of V2 Vaults

In V2, user total collateral value = NonKerosene collateral + KeroseneVault collateral

Because KEROSENE token price can easily manipulated by user, so is the KeroseneVault collateral value.

With 150% of collateralRatio minimum.
If V2 user have 160% collateralRatio, with 120% made of NonKerosene collateral and 40% made of KeroseneVault collateral.
These user become target for force liquidation.

## Impact

Exploiter can force KEROSENE price to drop along with KeroseneVault value and collateral ratio fall below 150%.
Then liquidate V2 vaults for small profit.

With some restrictions:

- Exploiter **MUST** already deposit lots WETH in V1 vaults, but not taking any DYAD debt
- There is liquidable target hover around 160% collateral ratio with lots of Kerosene as collateral.
- Liquidation also refund KeroseneVault collateral to liquidator. Current project implementation did not take KeroseneVault value and transfer it to liquidator.
- This exploit does not work with flashloan.
- KEROSENE price depend on total TVL of both V1 and V2 like docs. Current implementation only use V2 TVL to calculate KEROSENE price, which make this exploit easier.
- Kerosene vaults is actual bounded,unbounded Kerosine vaults and not WETH,wstETH vaults like in current codebase.

## Proof of Concept

Here is simplified price formular from Docs and [code](https://github.com/code-423n4/2024-04-dyad/blob/49fb7174576e5147dc73d3222d16954aa641a2e0/src/core/Vault.kerosine.unbounded.sol#L50-L70):

- `Kerosene Price = (Total value Locked from V1 vaults and V2 Vault - minted DYAD supply) / KEROSENE in circulation`
- `Price = (TVL - debt)/ KEROSENE in circulation`

The only way for exploiter to benefit from decreasing Kerosene Price is liquidation.
By increasing DYAD supply, Kerosene Price will drop. KeroseneVault evaluation will drop as well.
<https://github.com/code-423n4/2024-04-dyad/blob/49fb7174576e5147dc73d3222d16954aa641a2e0/src/core/Vault.kerosine.unbounded.sol#L65>

To increase DYAD supply, simply exploiter must already have lots of WETH deposit inside Vaults but not minting any DYAD.
Then by minting maximum DYAD available, `(TVL - debt)` value will decrease.
There is no fee for minting and redeem DYAD so user can repay this later at no cost.

Now CollatRatio depend on `totalUSD value / borrow DYAD`.
<https://github.com/code-423n4/2024-04-dyad/blob/49fb7174576e5147dc73d3222d16954aa641a2e0/src/core/VaultManagerV2.sol#L230-L239>

Kerosene Vault values depend on vault calculating value.
<https://github.com/code-423n4/2024-04-dyad/blob/49fb7174576e5147dc73d3222d16954aa641a2e0/src/core/VaultManagerV2.sol#L271-L288>

Because in current codebase, wrong KeroseneVault is added to `VaultManagerV2`
<https://github.com/code-423n4/2024-04-dyad/blob/49fb7174576e5147dc73d3222d16954aa641a2e0/script/deploy/Deploy.V2.s.sol#L64-L65>
<https://github.com/code-423n4/2024-04-dyad/blob/49fb7174576e5147dc73d3222d16954aa641a2e0/script/deploy/Deploy.V2.s.sol#L95-L96>

Just assume `getKeroseneValue()` call into correct vault which are `UnboundedKerosineVault` and `BoundedKerosineVault`.
Kerosene price calculation follow formula above.
<https://github.com/code-423n4/2024-04-dyad/blob/49fb7174576e5147dc73d3222d16954aa641a2e0/src/core/Vault.kerosine.unbounded.sol#L58-L67>

Kerosene price drop so are KeroseneVault value.

Liquidation now possible for vaults with 160% collateral ratio and suddenly drop to 120%-150% due to drop in KEROSENE value.

## Tools Used

## Recommended Mitigation Steps

KEROSENE TWAP oracle seem like good idea here.
