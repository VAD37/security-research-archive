# It cost ~4000 gas to DOS `VaultManagerV2` withdrawal. Anyone can use `deposit()`

`VaultManagerV2.deposit()` allow anyone to deposit to any NFT account.

New flashloan protection prevent user from deposit and withdrawal from same block.
This allow anyone to DOS withdrawal by frontrun deposit 0 token before withdrawal transaction.

## Impact

With current DANCUN gas price 10gwei. It cost ~0.2$ to DOS withdrawal.
Because there is only active 300 DNFT in circulation, 300 user can make withdrawal.
It is quite cheap to make DOS attacks just for annoying people.

## Proof of Concept

This test was used to get DOS minimum 4000 gas figure.

```solidity
// SPDX-License-Identifier: MIT
pragma solidity =0.8.17;

import "forge-std/console.sol";
import "forge-std/Test.sol";

import "../../script/deploy/Deploy.V2.s.sol";
import { Licenser } from "../../src/core/Licenser.sol";
import { Parameters } from "../../src/params/Parameters.sol";

contract VaultTest {
  function asset() external view returns (address) {
    return address(this);
  }

  function transferFrom(address from, address to, uint256 value) external returns (bool) {
    return true;
  }

  function deposit(uint256 id, uint256 amount) external { }
}

contract V2Test is Test, Parameters {
  Contracts contracts;

  function setUp() public {
    contracts = new DeployV2().run();
  }


  function testGasCostDeposit() public {
    address user = address(0x11111);
    vm.startPrank(user);
    //buying new NFT ID
    deal(user, 100 ether);
    uint256 id = DNft(MAINNET_DNFT).mintNft{ value: 10 ether }(user); //@refunfed

    //setup vault
    VaultManagerV2 vaultManagerV2 = VaultManagerV2(contracts.vaultManager);
    vaultManagerV2.add(id, address(contracts.ethVault));

    ERC20(MAINNET_WETH).approve(address(vaultManagerV2), type(uint256).max);
    deal(MAINNET_WETH, user, 10 ether);
    vaultManagerV2.deposit(id, address(contracts.ethVault), 10 ether);

    VaultTest vaultTest = new VaultTest();
    uint gas_before = gasleft();
    vaultManagerV2.deposit(id, address(vaultTest), 0);
    uint gas_after = gasleft();
    console.log("gas cost %e", gas_before - gas_after);
    //@ 3.976e3 gas
    vm.stopPrank();
  }

}

```

## Tools Used

<https://github.com/code-423n4/2024-04-dyad/blob/49fb7174576e5147dc73d3222d16954aa641a2e0/src/core/VaultManagerV2.sol#L143>
<https://github.com/code-423n4/2024-04-dyad/blob/49fb7174576e5147dc73d3222d16954aa641a2e0/src/core/VaultManagerV2.sol#L127>

## Recommended Mitigation Steps

Include unique minimum deposit in each vault.
Admin should be allowed to change this.
Vault will revert if deposit amount is too small.

```solidity

contract Vault is IVault {
    
  uint public MINIMUM_DEPOSIT;


  function deposit(
    uint id,
    uint amount
  )
    external onlyVaultManager
  {
    require(amount >= MINIMUM_DEPOSIT, "deposit too small");
    id2asset[id] += amount;
    emit Deposit(id, amount);
  }

  function updateMinimumDeposit(uint amount) public {
    require(msg.sender == vaultManager.vaultLicenser().owner());
    MINIMUM_DEPOSIT = amount;
  }
```
