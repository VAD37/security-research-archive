# Unbounded Kerosine asset price calculation is incorrect. Causing always revert underflow and price manipulation

The underlying issue is Unbounded vault price not include V1 vaults TVL.
This broke logic rule describe here:
<https://dyadstable.notion.site/KEROSENE-Equations-Final-8655c83e0b7d44f883b9a99f499866c3>

## Impact

Incorrect Kerosene price calculated using only V2 vaults TVL. This cause several issues:

- Kerosene USD Price is undervalued. TVL smaller than it should be. Make it easier to manipulate price.
- User can't withdraw/mint/liquidate NFT include Unbounded Kerosine vault as collateral. This is because `collatRatio()` revert when V2 vault TVL smaller than total DYAD minted from both versions.

## Proof of Concept

`UnboundedKerosineVault.assetPrice()` always underflow at [this line](https://github.com/code-423n4/2024-04-dyad/blob/49fb7174576e5147dc73d3222d16954aa641a2e0/src/core/Vault.kerosine.unbounded.sol#L67):
`uint numerator   = tvl - dyad.totalSupply();`

`tvl` = total deposit USD value in WETH vault and wstVault
`dyad.totalSupply()` = total minted DYAD stablecoin from both `VaultManager` V1 and V2

There is already 600,000 DYAD token minted from V1.
So user must deposit 600,000$ worth of WETH or wstETH into `VaultManagerV2` vaults. Just so Kerosene calculation not underflow.

Vaults array loop only through latest V2 vaults.
<https://github.com/code-423n4/2024-04-dyad/blob/49fb7174576e5147dc73d3222d16954aa641a2e0/script/deploy/Deploy.V2.s.sol#L74-L75>
`KerosineManager` **must not** add V1 vaults address. So it can't calculate total TVL correctly.

```solidity
// SPDX-License-Identifier: MIT
pragma solidity =0.8.17;

import "forge-std/console.sol";
import "forge-std/Test.sol";

import "../../script/deploy/Deploy.V2.s.sol";
import { Licenser } from "../../src/core/Licenser.sol";
import { Parameters } from "../../src/params/Parameters.sol";


contract V2Test is Test, Parameters {
  Contracts contracts;

  function setUp() public {
    contracts = new DeployV2().run();
    vm.startPrank(MAINNET_OWNER);
    //include boundedKerosineVault
    contracts.vaultLicenser.add(address(contracts.boundedKerosineVault));
    // Add vaultManagerV2 to v1 licenser so it can mint DYAD
    Licenser(MAINNET_VAULT_MANAGER_LICENSER).add(address(contracts.vaultManager));
    vm.stopPrank();
  }

  function testDenominator() public {
    address user = address(0x11111);
    vm.startPrank(user);

    //buying new NFT ID
    deal(user, 100 ether);
    uint256 id = DNft(MAINNET_DNFT).mintNft{ value: 10 ether }(user); //@refunfed

    //setup vault
    VaultManagerV2 vaultManagerV2 = VaultManagerV2(contracts.vaultManager);
    ERC20(MAINNET_WETH).approve(address(vaultManagerV2), type(uint256).max);

    vaultManagerV2.add(id, address(contracts.ethVault));
    vaultManagerV2.add(id, address(contracts.wstEth));

    //388 WETH inside V1 vault. so new vault must have 400 ETH before it can be run.
    uint256 wethPrice = (contracts.ethVault.assetPrice() * 1e18) / 1e8;
    uint256 totalDYAD = Dyad(MAINNET_DYAD).totalSupply();
    uint256 minimumETH = (totalDYAD / wethPrice) * 1e18;
    console.log("minimum ETH for Kerosine vault to work %e", minimumETH);

    deal(MAINNET_WETH, user, minimumETH + 10 ether);
    uint256 depositAmount = minimumETH + 1e1;
    vaultManagerV2.deposit(id, address(contracts.ethVault), depositAmount);
    //197 ETH with  3100$ price = 610700$ total TVL
    console.log("totalTVL %e", vaultManagerV2.getTotalUsdValue(id));
    vaultManagerV2.addKerosene(id, address(contracts.ethVault));
    vaultManagerV2.addKerosene(id, address(contracts.wstEth));
    console.log("totalTVL %e", vaultManagerV2.getTotalUsdValue(id));

    //@audit try withdrawal will just fail
    vm.roll(block.number + 1);
    vaultManagerV2.withdraw(id, address(contracts.ethVault), 0,user);

    console.log("collatRatio %e", vaultManagerV2.collatRatio(id));
    console.log("denominator %e", contracts.kerosineDenominator.denominator());
    console.log("ethVaultPrice %e", contracts.ethVault.assetPrice());
    console.log("wstEthPrice %e", contracts.wstEth.assetPrice());
    //@audit this fail
    console.log("unboundedAssetPrice %e", contracts.unboundedKerosineVault.assetPrice());
    console.log("boundedAssetPrice %e", contracts.boundedKerosineVault.assetPrice());

    vm.stopPrank();
  }

}

```

### price manipulation

If KerosineManager only include V2 Vaults. Exploiter can use V1 vaults to mint lots DYAD. This increase DYAD totalSupply while TVL stay the same.
KerosineManager price of KEROSENE will just drop to zero if there is enough DYAD minted.
Causing KEROSENE vault collateral on V2 price drop significantly. Allowing liquidation of everyone who use KEROSENE as collateral.
Refund DYAD and repay flashloan and profit.

## Tools Used

<https://github.com/code-423n4/2024-04-dyad/blob/49fb7174576e5147dc73d3222d16954aa641a2e0/src/core/Vault.kerosine.unbounded.sol#L67>

## Recommended Mitigation Steps

Kerosine asset price should be moved to its own custom oracle that track all vaults. From both v1 and v2 vaults

`KeroseneManager` should not be used as Licenser contract.
Separate Licenser logic from KerosineManager work better.
