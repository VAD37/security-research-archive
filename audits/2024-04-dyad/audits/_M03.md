# If Admin remove license from active vault. Liquidation still take tokens from deprecated vaults when it is not used as collateral

When a vault is deprecated and removed from license list, the deprecated vault is not included as collateral.

If this vault is active and there is user deposit lots of token, collateral drop might be enough for liquidation.

Liquidation also take tokens from all vaults including deprecated vault not part of collateral calculation.

## Impact

Unfair liquidation taking away assets not belong to collateral anymore when admin remove vault license.

## Proof of Concept

Summarize underlying issue with 2 lines:

1. [Getting Total Collateral USD value exclude vault missing license.](https://github.com/code-423n4/2024-04-dyad/blob/49fb7174576e5147dc73d3222d16954aa641a2e0/src/core/VaultManagerV2.sol#L241-L286)
2. [liquidation does not check vault is licensed before transfer assets from user to liquidator.](https://github.com/code-423n4/2024-04-dyad/blob/49fb7174576e5147dc73d3222d16954aa641a2e0/src/core/VaultManagerV2.sol#L221-L226)

User have 2000$ `wstETH` and 500$ `WETH` deposit as collateral in 2 vaults belong to `VaultManagerV2`.
If they mint 1000$ DYAD, they have 1000$ debt and 2500$ collateral.

If admin revoke `wstETH` vault license. Now, `wstETH` is excluded when calculating total collateral USD value.
Total Collateral is only worth 500$ with `WETH` vault.

When liquidation happen, it will take tokens away from all vaults belong to NFT user. Including deprecated vault.

```solidity
      uint numberOfVaults = vaults[id].length();//@liquidation read from all vaults. 
      for (uint i = 0; i < numberOfVaults; i++) {
          Vault vault      = Vault(vaults[id].at(i));//@ removed-license vault still exist inside vaults[]
          uint  collateral = vault.id2asset(id).mulWadUp(liquidationAssetShare);
          vault.move(id, to, collateral);
      }
```

Then 2000$ worth of `wstETH` and 500$ `WETH` is transfered to liquidator after repay 1000$ DYAD debt.

## Tools Used

## Recommended Mitigation Steps
