
# Fork POC: Manipulating `DebtToken.sol` to inflate interest rate via AAVE

## Summary*

The `DebtToken.sol` contract can be manipulated to cache an inflated interest rate (up to 19% APR) sourced from AAVE. This leads to significantly higher debt being accrued by agents or operators upon repayment.

The manipulation is invisible in public views or the oracle UI and is only exposed during repayment. Since the exploit requires only gas fees and no capital loss to the attacker, this is classified as a High severity issue.

## Root Cause*

- In `DebtToken.sol`, interest rate is depend on `AaveAdapter.sol` oracle. Which is 3rd party oracle that fluctuate, if exploited can return inflated value.
<https://github.com/sherlock-audit/2025-07-cap-VAD37/blob/6473ce3fef4c5c3adca7d2683e6adb2a3c24739f/cap-contracts/contracts/lendingPool/tokens/DebtToken.sol#L95-L104>
- Interest rate can be calculated as: `interestRate = max(aave market rate, default benchmark rate) + VaultAdapter rate`
- AAVE stable coin market rate can be push to maximum 20% (normal it hover around 5%) depend on asset.
- AAVE does not take fee when borrow/repay, Exploiter can push aave rate in single transaction at zero-cost flashloan
- `Lending.sol` have this sneaky function `realizeRestakerInterest` which is public func allowing anyone to refresh `DebtToken` oracle rate for free

<https://github.com/sherlock-audit/2025-07-cap-VAD37/blob/6473ce3fef4c5c3adca7d2683e6adb2a3c24739f/cap-contracts/contracts/lendingPool/tokens/DebtToken.sol#L72-L104>


## Internal Pre-conditions*

- This happen using default scenario and default settings in project provided POC `Scenario.basic.t.sol` file.
- Cap Project is live and whitelisted agent borrowing from protocol to invest elsewhere.
- Cap Project provide USDC,USDT,pyUSD as stable coin collateral

## External Pre-conditions*

- AAVE stable oracle rate is hover around 5%
- Cap Project oracle rate is 5% from aace + util rate of 2% = 7% APR
- There is no-fee flashloan provider like BalancerV2 which provide enough collateral capital for borrowing all AAVE stable coin pool.
- USDC, USDT require 1B collateral to push interest to maximum
- BalancerV2 alone enough to push pyUSD to maximum interest rate

## Attack Path*

- Exploiter use flashloan no-fee provider
- Get ~100M collateral in any tokens that aave accept as collateral
- Borrowing all USDT,USDC,PYUSD in AAVE pool
- AAVE market utilization is 100%, market rate is 19% APY maximum
- Exploiter transfer 1e0 USDT/USDC/PYUSD to `SymbioticNetworkMiddleware.sol` contract
- Exploiter call `Lender.realizeRestakerInterest()` to force refresh `DebtToken` oracle
- `DebtToken.sol` now update internal interestrate value
- repay AAVE with same amount of borrowing, repay flashloan collateral. No cost.
- When agent repay will refresh global debt with 19% interest rate instead of normal 5% aave interest rate.

## Impact

For normal 5% aave market, and maximum interest rate is 20%.

- The whitelisted agent (Symbiotic Network Operator) accrued x4 higher debt than normal.
- Exploiter lose gas fee to exucute attack after each operator lending. (There is not much activities so gas fee is acceptable)
- Restaker benefit from extra high interest repayment
- DebtToken interest rate does not show up in public view function. So the attack is hidden and undetectable unless someone digging through transactions.

Justification for High: lost of asset over long period of time before detection.

- Agent operator when pay higher borrowing premium rate to user.
- The attack is not detectable early for intervention

## PoC

Attached Coded POC is forking mainnet with AAVE, chainlink oracle and Symbiotic mainnet address.
Run with `forge test -vv --mc Debug` and put the file put in `cap-contracts\test\scenario\Scenario.fork1.t.sol`

The POC shows 10000$ borrowing (5% rate, exploit to 19% rate) after 3 days it incrue >10$ "extra" debt when realized.

## Mitigation

There is only 3 operations that refresh `DebtToken` global interest rate.
Through `Lender.sol` borrow/repay/realizeRestakerInterest.

Borrow require whitelisted `msg.sender` (operator only)
Repay require 100$ minimum repayment
Anyone can call `realizeRestakerInterest()`

So by turning `realizeRestakerInterest()` function to whitelisted operation. It prevent users from exploiting oracle.

Otherwise find TWAP for aave oracle market rate
