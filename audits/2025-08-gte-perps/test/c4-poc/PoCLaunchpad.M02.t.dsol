// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "./LaunchpadTestBase.sol";
import {SafeTransferLib} from "@solady/utils/SafeTransferLib.sol";
import "contracts/launchpad/libraries/RewardsTracker.sol";

contract PoCLaunchpad is LaunchpadTestBase {
    using SafeTransferLib for address;


    function test_debug_submissionValidity() external {
        fundAndApproveUser(dev, 100 ether);
        fundAndApproveUser(user, 100 ether);

        buyLaunchToken(token, dev, 150_000_000e18);
        buyLaunchToken(token, dev, 120_000_000e18);
        buyLaunchToken(token, dev, 130_000_000e18);

        //expect revert here
        console.log("--next call should not be revert--");
        vm.expectRevert(address(launchpad.currentBondingCurve()));
        sellLaunchToken(token, dev, 400_000_000e18);
        //sell 400M base token to ~6.66666666e18 quote token
        //quote reserve is ~16.666666665e18
        //this push the quote reserve below 10e18
        //virtual reserve is 10e18
    }


    function fundAndApproveUser(address _user, uint256 amount) internal {
        quoteToken.mint(_user, amount);
        vm.startPrank(_user);
        quoteToken.approve(address(launchpad), type(uint256).max);
        ERC20Harness(token).approve(address(launchpad), type(uint256).max);
        vm.stopPrank();
    }

    function buyLaunchToken(address _token, address fromUser, uint256 amountOutBase) internal {
        vm.startPrank(fromUser);
        launchpad.buy(
            ILaunchpad.BuyData({
                account: fromUser,
                token: _token,
                recipient: fromUser,
                amountOutBase: amountOutBase,
                maxAmountInQuote: type(uint256).max
            })
        );
        vm.stopPrank();
    }

    function sellLaunchToken(address _token, address fromUser, uint256 amountInBase) internal {
        vm.startPrank(fromUser);
        launchpad.sell(fromUser, _token, fromUser, amountInBase, 0);
        vm.stopPrank();
    }
}
