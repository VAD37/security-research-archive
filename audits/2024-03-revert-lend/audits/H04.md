# `V3Vault.sol` accept NFT from pool no one is using with low liquidity. Allow oracle price manipulation and steal tokens from the pool

`V3Vault.sol` allow user deposit any uniswapNFT and borrow against them. As long as oracle can calculate these NFT worth.

But some pool like `(USDC,DAI,fee = 10000)` exist with no liquidity.
<https://etherscan.io/address/0x6958686b6348c3D6d5f2dCA3106A5C09C156873a#code>

`V3Vault.sol` check this low liquidity pool have similar price as other pool with high liquidity as valid. It use same chainlink and TWAP oracle feeds to calculate value of this low liquidity pool.
But what it cant do is checking if some extreme tick position can be instantly reached due to low liquidity.

This allow attacker use this low liquidity pool to create extreme NFT uniswap position and borrow against it then trading with unfair price in manipulated pool for profit.

## Impact

User steal money from Vault using uniswapV3 mechanism of low liquidity pool and positions in single block.

## Proof of Concept

Using this [low liquidity pool `(USDC,DAI,fee = 10000)`](https://etherscan.io/address/0x6958686b6348c3D6d5f2dCA3106A5C09C156873a#code)

Making absurd UniswapNFT positions holding (10000 USDC, 0.1 DAI) in this low liquidity pool.
Exploiter can create NFT position that only kick in when price reach 10000 USDC = 0.1 DAI.

The pool exchange price still 1 DAI = 1 USDC.
Except the liquidity in tick 1 DAI = 1 USDC is just 5$ of liquidity.
While liquidity in tick 0.1 DAI = 10000 USDC is 10000$ of liquidity.

`V3Vault` use oracle and consider this position worth 10000$ and can borrow 8000$ USDC against it.

Attacker transfer this NFT and borrow 8000 USDC against it.
Then swap ~10 DAI for 8000 USDC.
This UniswapNFT position now worth (2000 USDC, 10 DAI).
Exploiter just profit 6000 USDC from Vault.

### Step by step

1. `V3Vault.sol` accept any uniswapNFT positions as collateral. Even when it hold wrong non-supported token.
<https://github.com/code-423n4/2024-03-revert-lend/blob/435b054f9ad2404173f36f0f74a5096c894b12b7/src/V3Vault.sol#L427-L475>
2. Borrow using NFT as collateral use `V3Oracle.sol` to calculate how much token this position hold.
<https://github.com/code-423n4/2024-03-revert-lend/blob/435b054f9ad2404173f36f0f74a5096c894b12b7/src/V3Vault.sol#L591-L593>
<https://github.com/code-423n4/2024-03-revert-lend/blob/435b054f9ad2404173f36f0f74a5096c894b12b7/src/V3Vault.sol#L1270-L1279>
3. `V3Oracle.sol` use UniswapPool to calculate holding of this NFT position. It get how much token this position is holding depend on tick price and tick position.
<https://github.com/code-423n4/2024-03-revert-lend/blob/435b054f9ad2404173f36f0f74a5096c894b12b7/src/V3Oracle.sol#L101-L102>
4. Liquidity math just use regular UniswapMath. It does not care what
5. Oracle also check if this pool price is within 2% range of main pool price.
<https://github.com/code-423n4/2024-03-revert-lend/blob/435b054f9ad2404173f36f0f74a5096c894b12b7/src/V3Oracle.sol#L133-L137>

```solidity
    function _checkPoolPrice(address token0, address token1, uint24 fee, uint256 derivedPoolPriceX96) internal view {
        IUniswapV3Pool pool = _getPool(token0, token1, fee);
        uint256 priceX96 = _getReferencePoolPriceX96(pool, 0);
        _requireMaxDifference(priceX96, derivedPoolPriceX96, maxPoolPriceDifference);
    }
```

6. To bypass this pool price safety check. Create NFT positions does not affect pool price if it have tick on extreme position.
For example using USDC/DAI v3 pool with fee 10000.
The liquidity for tick 1 USDC=1 DAI is just 5$ of liquidity.
There is nothing to stop user from creating NFT position that only kick in when price reach 10000 USDC = 0.1 DAI.
This mean `V3Vault` and `V3Oracle` will accept this NFT with extreme tick position as having fair price
7. Oracle consider this position holding 10000 USDC and 1 DAI worth 10000$ using price feed.
8. `V3Vault` allow user borrow 8000 USDC against this NFT position.
9. Swapping some DAI for USDC in this manipulated pool.
10. The NFT position collateral now worth less than original borrowed amount.

## Tools Used

## Recommended Mitigation Steps

To deny NFT from pool with low liquidity.
Whitelist acceptable UniswapNFT pool seem like easiest options.

It is not viable for Oracle to check both pool both price and liquidity as reasonable.
