# `V3Vault.reserveFactorX32` take away interest profit from lender into reserve without mechanism to increase it or return/reward it back to user

When admin increase `V3Vault.reserveFactorX32` to non zero value. It reduce `lastLendExchangeRateX96` speed of increasing. This mean user receive less interest than they should. Because some of these interest now transfer to the pool as reserve.

And these interest that now belong to reserve will permanently stuck inside the pool. Providing liquidity for user withdrawing or borrowing.
Lenders can never receive this profit.
With the exception of admin/governance through `withdrawReserves()`.

In Compound, they have compensation mechanism for user when they take away some of profit. Which is just Comp token reward. Or special interest rate model that allow temporary increasing supplyRate for a time.

But `V3Vault` does not have this mechanism, just admin function take away reserve without compensation.

## Impact

Unintended reduction of interest profit from lender to increase liquidity of the pool.
When admin use pool profit to turn into reserve, this profit money is taken away from lender.

## Proof of Concept

### some concept from Compound

Some of these concept from Compound:

- SupplyIndex is `lastLendExchangeRateX96` in `V3Vault`
- BorrowIndex is `lastDebtExchangeRateX96` in `V3Vault`

SupplyIndex is user to track all user principle + "virtual" interest accrued so far.
BorrowIndex is used to track all loan + "virtual" interest repayment expected from borrower.

"virtual" here mean user suppose to receive/repay this much but actual pool might have less available balance because not every debt have been repaid yet. The pool only hold collateral for now, the repay interest might happen later.

### Explain how exchange rate work in `V3Vault`

`lastLendExchangeRateX96` is used to tracking all USDC provided by user to the pool + "virtual" interest that need to pay out to all users.

The idea behind `reserveFactorX32` is it help provide liquidity to the pool so people can exit when some loan have not been repaying interest yet.

`reserveFactorX32` just reduce supply rate ranging from 0-100%.

Here is simplified math fomular:
`lastLendExchangeRateX96` = `lastLendExchangeRateX96` + time * (supplyRate - reserveFactor)

For example:
If pool suppose to payout 100$ USDC in interest, `lastLendExchangeRateX96` value increase from 1.000 to 1.001. And `reserveFactorX32` is 10%. The pool only payout 90$ USDC in interest, 10$ USDC will be part of "virtual" reserve.

Now `lastLendExchangeRateX96` will only increase from 1.000 to 1.0009. Which is less than it should be.

Withdraw share from pool will be 10% less than it should be.
Here is simplified withdraw token formula:
`assetOut = share * (lastLendExchangeRateX96) / Q96`

Of course, these 10$ does not gone anywhere. It is still inside the pool.
It is just not part of "virtual" interest that lender suppose to receive.
And again, the borrower index still stay the same. The borrower still owe full 100$ USDC in interest.
`lastDebtExchangeRateX96` value will still increase from 1.000 to 1.001

The different between 2 exchange rate is the reserve of the pool.
`lastDebtExchangeRateX96` - `lastLendExchangeRateX96` = reserve = 0.001

This 0.001 value represent 10$ USDC that stuck inside the pool. Acting as liquidity.

### Why interest now stuck inside the pool

Assuming extreme condition that no more borrow activity. `lastDebtExchangeRateX96` never increasing again, same with `lastLendExchangeRateX96`. Due to supplyRate and borrowRate both 0.

All share convert to USDC now only worth 90$ instead of 100$. While borrower already repay 100$ USDC in interest.
Now we have a pool that have 10$ USDC stuck inside it. And no one can take it out.

### Accessing reserve

<https://github.com/code-423n4/2024-03-revert-lend/blob/435b054f9ad2404173f36f0f74a5096c894b12b7/src/V3Vault.sol#L761-L783>
Both in Compound and RevertLend. There is this `withdrawReserves()` function. This function allow admin to take out reserve from the pool.
Same as accessing stuck interest inside the pool.

Unlike Compound, RevertLend does not have any mechanism to compensate user for taking away their interest profit. This just being mean to lender.

## Tools Used

<https://github.com/code-423n4/2024-03-revert-lend/blob/435b054f9ad2404173f36f0f74a5096c894b12b7/src/V3Vault.sol#L1181-L1181>
<https://github.com/code-423n4/2024-03-revert-lend/blob/435b054f9ad2404173f36f0f74a5096c894b12b7/src/V3Vault.sol#L761-L783>

## Recommended Mitigation Steps

The easiest way is to manually increase `lastLendExchangeRateX96` by the same amount as `reserveFactorX32` decrease.
This process normally happen in `InterateRateModel` where supplyRate multiplied by special rate that can be increase by admin.

```solidity
    function getRatesPerSecondX96(uint256 cash, uint256 debt)
        public
        view
        override
        returns (uint256 borrowRateX96, uint256 supplyRateX96)
    {
        uint256 utilizationRateX96 = getUtilizationRateX96(cash, debt);

        if (utilizationRateX96 <= kinkX96) { //< 80% . borrow rate = util * 5% + base.
            borrowRateX96 = (utilizationRateX96 * multiplierPerSecondX96 / Q96) + baseRatePerSecondX96;
        } else {//@ debt > 80% total cash
            uint256 normalRateX96 = (kinkX96 * multiplierPerSecondX96 / Q96) + baseRatePerSecondX96; // max normalRate = 80% * 5%
            uint256 excessUtilX96 = utilizationRateX96 - kinkX96;
            borrowRateX96 = (excessUtilX96 * jumpMultiplierPerSecondX96 / Q96) + normalRateX96;
        }

        supplyRateX96 = utilizationRateX96 * borrowRateX96 / Q96;
+++        supplyRateX96 = supplyRateX96 * supplyRateMultiplier /Q96;
        //@ supplyRatemultiplier is just new variable controlled by admin to compenstate for reserveFactorX32

        //@audit H there must be a way for supply exchange rate catching up to borrow rate. otherwise, tehre will be funds missing due to convert share from borrow and lending rate difference.
    }
```