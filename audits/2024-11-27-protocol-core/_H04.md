
# Cash Token Approval to Loans KeeperBot Exploit

## Summary

`LoansNFT.closeLoan()` allows the KeeperBot to close a loan if the Loan NFT owner has enough cash and sufficient allowance. This can be abused by transferring in an NFT created by an attacker. This NFT can hold a negative balance sheet, allowing the KeeperBot to automatically close the loan, siphoning cash from the user’s account and transferring huge late penalty fees to the attacker’s account.

---

## Finding Description

Throughout the Collar codebase, there are only two instances of `ERC20.safeTransferFrom()` where `from != msg.sender`. Assuming maximum approval is the norm, this can be exploited to steal funds if not properly validated.

One such instance occurs in `LoansNFT.closeLoan()`:
<https://github.com/CollarNetworks/protocol-core/blob/3eadf114e72ff49b3096c221f0d8d31951a38292/src/LoansNFT.sol#L251>

Here’s a simplified explanation of how `LoansNFT.closeLoan()` works:

1. Verifies that `msg.sender` is either the NFT owner or a whitelisted KeeperBot with owner permissions.
2. Retrieves all possible CASH from the Taker/Provider position.
3. Take the loan repayment amount in CASH from the NFT owner wallet.
4. Swaps all CASH for the underlying asset.
5. Pays any potential late fees to the Escrow contract or provides refunds for early closing in the underlying asset.
6. Transfers any remaining underlying asset to the NFT owner.

### Exploitable Condition

If the KeeperBot automatically refreshes Loans NFT ownership every minute and checking:

- The user has called `LoansNFT.setKeeperApproved()` to approve the KeeperBot to close loans.
- The user has provided a cash token allowance.
- The user address has enough CASH to repay the loan.

An attacker can exploit this by transferring a LoansNFT ERC721 with unfavorable conditions to the user’s account. Specifically, the attacker can create a Loan NFT where:

- The profit from the Taker position is reduced to zero.
- There are significant late fees accumulated as penalties.

When the KeeperBot automatically closes this loan, following the steps above, the CASH is taken from the NFT owner, swapped into the underlying asset, and partially used to pay the late fees to the attacker.

As a result, the user ends up with a loss, and the attacker profits from the Escrow penalties.

---

## Impact Explanation

This is a high-severity issue because the exploit allows for significant monetary gain by the attacker with no downside.

---

## Likelihood Explanation

The likelihood of this exploit depends on how the off-chain KeeperBot is implemented. If the KeeperBot operates as a simple bot as described, the exploit is likely.

If the KeeperBot account is compromised, this attack can steal funds from all users who have approved the KeeperBot address and still have USDC allowance set for `LoansNFT.sol`.

---

## Proof of Concept

**Assumptions:**  
1 WETH = 1,000 USDC.

**Steps:**

1. Attacker creates a Provider offer with:
   - 99.99% put strike percentage
   - 100.01% call strike percentage
   - Minimum duration of 5 minutes.
2. Attacker creates an Escrow offer with:
   - 1,200% late fee penalty
   - Maximum 30-day grace period
   - Minimum duration of 5 minutes.
3. Attacker creates a LoansNFT with the above Provider and Escrow offers.
4. Attacker creates a loan of 10,000 USDC, with 10 WETH as escrow.
5. After 5 minutes, the price drops 0.1%, causing the Provider to gain 100% of the locked value in the Taker position.
6. The Taker/Provider positions are settled, but the loan remains open.
7. The attacker recovers most of the 10,000 USDC locked in the Provider position and retains 10 WETH held in the Escrow contract.
8. The attacker waits a few days for late fees to accumulate, up to the maximum of 30 days, resulting in a ~9.8 WETH late fee (98% of 10 WETH).
9. The attacker transfers the LoansNFT to another user who meets the exploit conditions outlined above.
10. The KeeperBot calls `LoansNFT.closeLoan()` to close the loan:
    - 10,000 USDC is deducted from the user’s account.
    - The user gains the Taker position, but it has no value.
    - 10,000 USDC is swapped for 10 WETH.
    - 9.8 WETH is transferred as late fees to the Escrow contract (benefiting the attacker).
    - 0.2 WETH is transferred to the user’s account.

**Outcome:**  
The user loses 10,000 USDC and receives only 0.2 WETH in return.

---

## Recommendation

Currently, there is no perfect fix without compromising some functionality. However, the following mitigations can help:

1. Prevent Loans ERC721 transfers unless they are made through authorized Collar contracts.
2. Add a check in `closeLoan()` to ensure that repayment does not result in a negative balance sheet for the borrower. *(This may still be exploitable.)*
