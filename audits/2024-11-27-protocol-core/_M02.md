
# Exploit: Avoiding Escrow Late Fee via Loan Closing Swap Without Price Protection

## Summary

Under mainnet conditions, borrowers can potentially avoid paying full late fees through a self-sandwich exploit during loan closure. This exploit manipulates the loan repayment swap to reduce late fees to near zero.  
**However, this exploit is impractical** as it provides no meaningful gain or incentive for anyone to execute it.

---

## Finding Description

When closing a loan, the borrower repays the loan in full to reclaim their gains from the Taker position and any leftover funds after deducting the escrow fee. Below is the process in `LoansNFT.closeLoan()`:

1. The borrower sends the full loan repayment amount in USDC. ([Ref](https://github.com/CollarNetworks/protocol-core/blob/3eadf114e72ff49b3096c221f0d8d31951a38292/src/LoansNFT.sol#L251))  
2. `LoansNFT` settles the Taker position and receives all cash gains from it. ([Ref](https://github.com/CollarNetworks/protocol-core/blob/3eadf114e72ff49b3096c221f0d8d31951a38292/src/LoansNFT.sol#L243))  
3. The cash from the Taker position and loan repayment is swapped to the underlying asset (e.g., WETH). ([Ref](https://github.com/CollarNetworks/protocol-core/blob/3eadf114e72ff49b3096c221f0d8d31951a38292/src/LoansNFT.sol#L256))  
4. The swap output is sent to the Escrow contract to settle the repayment. ([Ref](https://github.com/CollarNetworks/protocol-core/blob/3eadf114e72ff49b3096c221f0d8d31951a38292/src/LoansNFT.sol#L770-L774))  
5. `EscrowSupplierNFT` deducts any late fees and sends the leftover funds to `LoansNFT`. ([Ref](https://github.com/CollarNetworks/protocol-core/blob/3eadf114e72ff49b3096c221f0d8d31951a38292/src/EscrowSupplierNFT.sol#L522-L531))  
6. Finally, `LoansNFT` transfers the remaining underlying asset to the borrower. ([Ref](https://github.com/CollarNetworks/protocol-core/blob/3eadf114e72ff49b3096c221f0d8d31951a38292/src/EscrowSupplierNFT.sol#L530-L531))  

The function `_conditionalReleaseEscrow()` deducts the late fee without swap price protection, which allows exploitation through Uniswap sandwich attacks. Borrowers manipulate the WETH/USDC swap to reduce `underlyingFromSwap` and avoid paying the full late fee while retaining Taker position gains.

```solidity
// release escrow if it was used, paying any late fees if needed
// @dev no slippage param / check on escrow release result since it depends only on time
// so cannot be manipulated and so can be checked off-chain / known in advance reliably
underlyingOut = _conditionalReleaseEscrow(loan, underlyingFromSwap);
```

This can be simplified to `underlyingOut = underlyingFromSwap - lateFee`. Escrow receives the full escrow amount and interest regardless of swap results.

Here is Final State under normal condition:

- **Escrower:** Receives original escrow amount + interest held + reduced late fee (partial or none).  
- **Borrower:** Gains full Taker position profits + loan repayment - any late fee.  

With exploit, borrower can avoid paying any late fee to Escrow.

---

## Proof of Concept (PoC)

### Preconditions

1. Loan amount: 1,000,000 USDC  
2. Escrow amount: 1,000,000 USDC with a 1200% late fee accrued over 29 days (900,000 USDC).  
3. Taker position: 500,000 USDC locked at 50% put and 200% call strike percentage. Gains now worth 1,500,000 USDC due to ETH price doubling.  
4. WETH/USDC 0.05% fee pool with 2,000,000 USDC and 200 ETH liquidity.  
5. Flash loan of 100,000,000 USDC with no fee available.  
If the borrower repays the loan, they receive 1,500,000 USDC from the Taker position and repay 900,000 USDC in late fees, resulting in only 600,000 USDC gain.

---

### Exploit Path

1. **Sandwich Attack:** Use the 100,000,000 USDC flash loan to manipulate the WETH/USDC Uniswap pool, reducing the spot price of WETH close to zero.  
   - Uniswap pool now holds a disproportionate amount of USDC and minimal WETH.  
   - The WETH/USDC spot price is near zero.  

2. **Call `closeLoan()`:**  
   - Send in the 1,000,000 repayment.  
   - `LoansNFT` swaps the USDC repayment at the manipulated rate, receiving minimal WETH.
   - WETH/USDC 0.05% virtual pool now hold 104,500,000 USDC and ~0 WETH

3. **Escrow Payment:**  
   - Escrow receives only a fraction of the late fee due to the reduced WETH output.  
   - Loan is closed successfully, avoiding the late fee payment.

4. **Reverse the Sandwich Attack:**  
   - Restore the Uniswap pool to equilibrium using the borrowed funds, reclaiming nearly all USDC and additional profits from the Taker position.
   - WETH/USDC 0.05% pool now hold ~2,100,000 USDC and 200 WETH. (100,000 USDC is pool fee gained from swap)
   - Borrower receive 2,400,000 USDC from uniswap

Borrower with exploit now gain 1,400,000 USDC instead of 600,000 USDC

---

## Impact Explanation

- Escrow is optional and primarily for tax reporting, providing no benefit for borrowers to use.  
- While there is a potential loss of funds, the exploit is **impractical** as borrowers have no incentive to execute it.  

**Severity: Medium** due to optional nature and low likelihood.

---

## Likelihood Explanation

In real-world deployment, borrowers are unlikely to deposit significant funds into Escrow, making the exploit economically unviable. Without substantial late fees, the exploit lacks any meaningful incentive.

---

## Recommendation

Add swap price protection to prevent manipulation during escrow repayment. This ensures the system remains robust, even though Escrow currently holds limited functional value beyond tax reporting.
